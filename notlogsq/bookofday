#!/bin/zsh

# Путь к CSV-файлу (относительно расположения скрипта или абсолютный)
CSV_FILE="$(dirname "$0")/books.csv"

# Проверка: передан ли аргумент
if [ $# -eq 0 ]; then
  echo "Использование: $0 <ключевое_слово>" >&2
  echo "Пример: $0 научпоп" >&2
  exit 1
fi

KEYWORD="$1"

# Проверка: существует ли файл
if [ ! -f "$CSV_FILE" ]; then
  echo "Ошибка: файл $CSV_FILE не найден." >&2
  exit 2
fi

# Найти все строки, где ключевое слово есть в третьем поле (ключевые слова)
# Учитываем, что ключевые слова могут идти через пробел, и мы ищем целое слово
# Используем awk для точного поиска по полю
MATCHES=$(awk -v kw="$KEYWORD" -F',' '
  {
    gsub(/^[ \t]+|[ \t]+$/, "", $3)  # убрать пробелы в начале/конце 3-го поля
    n = split($3, tags, /[ \t]+/)
    for (i = 1; i <= n; i++) {
      if (tags[i] == kw) {
        print $1 ", " $2
        break
      }
    }
  }
' "$CSV_FILE")

# Если совпадений нет
if [ -z "$MATCHES" ]; then
  echo "Нет книг с ключевым словом: $KEYWORD" >&2
  exit 3
fi

# Выбрать случайную строку из совпадений
echo "$MATCHES" | shuf -n 1